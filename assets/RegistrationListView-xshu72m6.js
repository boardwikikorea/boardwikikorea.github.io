import{s as w,w as S,M as B,d as V,u as A,E as F,r as j,x as L,g as D,c as l,b as t,a as h,t as s,e as a,z as M,k as N,v as T,F as y,h as k,o as c,n as E,i as z}from"./index-ndEzk6YG.js";async function I(i){return S(async()=>{const{data:e,error:r}=await w.from("event_registration").select(`
        id,
        event_id,
        state,
        created_at,
        profile:profile_id (
          id,
          nickname
        ),
        options:event_registration_option (
          id,
          music_text,
          event_option (
            id,
            name,
            code,
            option_category,
            gender_type,
            round_type,
            music_request_use,
            countable
          )
        ),

        cancel:event_registration_cancel (
          id,
          status,
          requested_at
        )
      `).eq("event_id",i).order("created_at",{ascending:!1});if(r)throw r;return(e??[]).map(d=>{var v,p,g;return{...d,profile:Array.isArray(d.profile)?d.profile[0]??null:d.profile,cancelRequested:((v=d.cancel)==null?void 0:v.some(b=>b.status==="requested"))??!1,cancelId:((g=(p=d.cancel)==null?void 0:p[0])==null?void 0:g.id)??null}})})}async function P(i,e){return S(async()=>{const{error:r}=await w.from("event_registration").update({state:e}).eq("id",i);if(r)throw r})}async function U(i,e){const{error:r}=await w.rpc("process_event_registration_cancel",{p_registration_id:i,p_action:e});if(r)throw r}const G=B("admin-event-registration",{state:()=>({registrations:[],loading:!1}),actions:{async fetchByEvent(i){this.loading=!0;try{this.registrations=await I(i)}finally{this.loading=!1}},async updateState(i,e){await P(i,e);const r=this.registrations.find(d=>d.id===i);r&&(r.state=e)},async processCancel(i,e){await U(i,e);const r=this.registrations.find(d=>d.id===i);r&&(r.cancelRequested=!1,e==="approve"&&(r.state="rejected"))}}}),H={class:"bg-neutral-50 dark:bg-neutral-900 min-h-[calc(100vh-54px)]"},J={class:"flex items-center justify-between mb-2"},K={class:"text-lg font-semibold text-neutral-800 dark:text-neutral-100"},O={class:"text-sm text-neutral-600 dark:text-neutral-400 mb-6"},Q={key:0,class:"text-sm text-neutral-500 dark:text-neutral-400 mb-4"},W={class:"mb-6 flex flex-wrap items-center gap-4 justify-between"},X={class:"flex flex-wrap items-center gap-4"},Y=["placeholder"],Z={class:"flex gap-2"},ee=["onClick"],te={class:"overflow-x-auto bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-sm"},ne={class:"w-full border-collapse"},se={class:"bg-neutral-100 dark:bg-neutral-700"},ae={class:"px-4 py-3 text-xs font-semibold text-left"},re={class:"px-4 py-3 text-xs font-semibold text-center"},oe={class:"px-4 py-3 text-xs font-semibold text-left"},ie={class:"px-4 py-3 text-xs font-semibold text-center w-40"},le={class:"px-4 py-3 text-center text-sm text-neutral-500"},ce={class:"px-4 py-3"},de={class:"text-sm text-neutral-900 dark:text-neutral-100"},ue={class:"px-4 py-3 text-center"},pe={class:"flex flex-col items-center gap-1"},xe={key:0,class:"inline-flex px-2 py-0.5 text-[11px] rounded-full bg-orange-100 text-orange-700"},ge={class:"flex flex-col items-center gap-1 mt-1"},_e={key:0,class:"flex gap-1"},me=["onClick"],he=["onClick"],ve={key:1,class:"flex gap-1"},fe=["onClick"],be=["onClick"],ye={class:"px-4 py-3 text-sm"},ke={key:0},we={key:0,class:"text-xs text-neutral-500"},Re={key:1},Ce={class:"px-4 py-3 text-center text-sm"},qe={key:0},$e={colspan:"5",class:"px-4 py-10 text-center text-sm text-neutral-500"},Ee=V({__name:"RegistrationListView",setup(i){const{t:e}=A(),r=F(),d=M(),v=r.params.eventId,p=G(),g=j(""),b=["all","pending","approved","rejected"],f=j("all");async function R(u,o){if(confirm(e(`admin.eventRegistration.confirm.${o}`)))try{await p.updateState(u.id,o)}catch(n){alert(e("admin.eventRegistration.alert.updateError")),console.error(n)}}L(async()=>{try{await p.fetchByEvent(v)}catch(u){console.error(e("admin.eventRegistration.alert.listError"),u)}});const C=D(()=>{let u=p.registrations??[];f.value!=="all"&&(u=u.filter(n=>n.state===f.value));const o=g.value.trim().toLowerCase();return o&&(u=u.filter(n=>{var _,m;return(m=(_=n.profile)==null?void 0:_.nickname)==null?void 0:m.toLowerCase().includes(o)})),u});async function q(u,o){if(confirm(e(`admin.eventRegistration.confirm.cancel.${o}`)))try{await p.processCancel(u.id,o)}catch(n){alert(e("admin.eventRegistration.alert.updateError")),console.error(n)}}return(u,o)=>(c(),l("main",H,[t("div",J,[t("h3",K,s(a(e)("admin.eventRegistration.listTitle"))+"s",1),t("button",{onClick:o[0]||(o[0]=n=>a(d).back()),class:"px-4 py-2 text-sm rounded-md bg-neutral-900 text-white hover:bg-neutral-800 dark:bg-white dark:text-neutral-900 dark:hover:bg-neutral-200"}," â† "+s(a(e)("common.button.back")),1)]),t("p",O,s(a(e)("admin.eventRegistration.listDescription")),1),a(p).loading?(c(),l("div",Q,s(a(e)("common.loading")),1)):h("",!0),t("div",W,[t("div",X,[N(t("input",{"onUpdate:modelValue":o[1]||(o[1]=n=>g.value=n),type:"text",placeholder:a(e)("admin.eventRegistration.searchPlaceholder"),class:"w-64 px-3 py-2 text-sm rounded-md border border-neutral-300 bg-white text-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-400 dark:bg-neutral-800 dark:text-neutral-100 dark:border-neutral-600"},null,8,Y),[[T,g.value]]),t("div",Z,[(c(),l(y,null,k(b,n=>t("button",{key:n,onClick:_=>f.value=n,class:E(["px-3 py-1.5 text-sm rounded-full border transition",f.value===n?"bg-neutral-900 text-white border-neutral-900 dark:bg-white dark:text-neutral-900":"bg-white text-neutral-700 border-neutral-300 hover:bg-neutral-100 dark:bg-neutral-800 dark:text-neutral-200 dark:border-neutral-600 dark:hover:bg-neutral-700"])},s(a(e)(`admin.eventRegistration.filter.${n}`)),11,ee)),64))])])]),t("div",te,[t("table",ne,[t("thead",se,[t("tr",null,[o[2]||(o[2]=t("th",{class:"px-4 py-3 text-xs font-semibold text-center w-16"},"#",-1)),t("th",ae,s(a(e)("admin.eventRegistration.table.user")),1),t("th",re,s(a(e)("admin.eventRegistration.table.state")),1),t("th",oe,s(a(e)("admin.eventRegistration.table.option")),1),t("th",ie,s(a(e)("admin.eventRegistration.table.createdAt")),1)])]),t("tbody",null,[(c(!0),l(y,null,k(C.value,(n,_)=>{var m,$;return c(),l("tr",{key:n.id,class:"border-t border-neutral-200 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition"},[t("td",le,s(_+1),1),t("td",ce,[t("span",de,s(((m=n.profile)==null?void 0:m.nickname)??"-"),1)]),t("td",ue,[t("div",pe,[t("span",{class:E(["inline-flex px-2 py-1 text-xs rounded-full",{"bg-yellow-100 text-yellow-700":n.state==="pending","bg-green-100 text-green-700":n.state==="approved","bg-red-100 text-red-700":n.state==="rejected"}])},s(a(e)(`admin.eventRegistration.state.${n.state}`)),3),n.cancelRequested?(c(),l("span",xe,s(a(e)("admin.eventRegistration.state.cancelRequested")),1)):h("",!0),t("div",ge,[n.cancelRequested?(c(),l("div",_e,[t("button",{onClick:x=>q(n,"approve"),class:"px-2 py-0.5 text-xs rounded bg-orange-600 text-white hover:bg-orange-700"},s(a(e)("admin.eventRegistration.action.approveCancel")),9,me),t("button",{onClick:x=>q(n,"reject"),class:"px-2 py-0.5 text-xs rounded bg-neutral-500 text-white hover:bg-neutral-600"},s(a(e)("admin.eventRegistration.action.rejectCancel")),9,he)])):n.state==="pending"?(c(),l("div",ve,[t("button",{onClick:x=>R(n,"approved"),class:"px-2 py-0.5 text-xs rounded bg-green-600 text-white hover:bg-green-700"},s(a(e)("admin.eventRegistration.action.approve")),9,fe),t("button",{onClick:x=>R(n,"rejected"),class:"px-2 py-0.5 text-xs rounded bg-red-600 text-white hover:bg-red-700"},s(a(e)("admin.eventRegistration.action.reject")),9,be)])):h("",!0)])])]),t("td",ye,[($=n.options)!=null&&$.length?(c(),l("div",ke,[(c(!0),l(y,null,k(n.options,x=>(c(),l("div",{key:x.id,class:"mb-1"},[z(s(x.event_option.name)+" ",1),x.music_text?(c(),l("span",we," ("+s(x.music_text)+") ",1)):h("",!0)]))),128))])):(c(),l("span",Re,"-"))]),t("td",Ce,s(n.created_at),1)])}),128)),!a(p).loading&&C.value.length===0?(c(),l("tr",qe,[t("td",$e,s(a(e)("admin.eventRegistration.empty")),1)])):h("",!0)])])])]))}});export{Ee as default};
