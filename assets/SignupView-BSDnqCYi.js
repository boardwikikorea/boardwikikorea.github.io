import{n as B,s as T,d as D,u as F,k as a,m as L,l as j,c as u,F as M,a as l,f as z,p as n,b as r,v as p,q as N,e as O,r as R,x as W,t as q,y as Z,o as d}from"./index-Bd0HrmgB.js";import{u as G}from"./profile-DRMi3-az.js";import{B as H}from"./BaseInputAutoCountry-Ba0_I-pS.js";async function J(){return B(async()=>{const{data:y,error:i}=await T.from("terms_version").select("id, title, version, content_url, is_required, type").eq("is_current",!0).order("created_at",{ascending:!0});if(i)throw i;return y??[]})}async function K(y,i){return B(async()=>{for(const o of i){const{error:m}=await T.from("user_terms_agreement").update({is_agreed:o.is_agreed}).eq("user_id",y).eq("terms_id",o.terms_id);if(m)throw console.error("[updateUserTermsAgreement]",m),m}})}const Q={class:"max-w-md mx-auto py-12 px-4"},X={class:"space-y-5 mb-10"},Y={class:"flex gap-2"},$={class:"space-y-4 mb-8"},h=["onUpdate:modelValue"],ee={key:0,class:"text-red-500"},le={key:1},te=["href"],se={key:0,class:"text-sm text-red-500 mb-6 text-center"},ae=["disabled"],oe={key:1,class:"text-center space-y-6"},de=D({__name:"SignupView",setup(y){const i=Z(),o=F(),m=a("form"),v=a(!1),g=a(""),k=a([]),f=a({}),w=a(""),V=a(""),c=a(""),C=a(null),U=a(null),S=a(null),x=a(null),b=a(""),_=a(""),A=L(()=>!V.value.trim()||!c.value.trim()||!U.value||x.value&&!b.value||!x.value&&b.value?!1:k.value.filter(s=>s.is_required).every(s=>f.value[s.id]===!0));j(async()=>{var s,e;o.user&&(w.value=o.user.email??"",c.value=((s=o.user.user_metadata)==null?void 0:s.full_name)??((e=o.user.user_metadata)==null?void 0:e.name)??"",k.value=await J(),k.value.forEach(t=>f.value[t.id]=!1))});async function E(){if(!(!A.value||v.value||!o.user)){v.value=!0,g.value="";try{await G(o.user.id,{nickname:V.value,fullName:c.value,gender:C.value,nationality:U.value,stance:S.value,contactEmail:w.value,contactPhoneCountry:x.value,contactPhone:b.value||null,region:_.value?{address:_.value,latitude:0,longitude:0}:null}),await K(o.user.id,Object.entries(f.value).map(([s,e])=>({terms_id:s,is_agreed:e}))),await o.ensureValidSession(),m.value="done"}catch(s){console.error(s),g.value=(s==null?void 0:s.message)??"회원가입 처리 중 오류가 발생했습니다."}finally{v.value=!1}}}function I(){const s=localStorage.getItem("post_login_redirect");if(s&&s.startsWith("/")){localStorage.removeItem("post_login_redirect"),i.replace(s);return}i.replace("/")}return(s,e)=>(d(),u("div",Q,[m.value==="form"?(d(),u(M,{key:0},[e[20]||(e[20]=l("h2",{class:"sound_only"},"회원가입",-1)),l("div",X,[l("div",null,[e[9]||(e[9]=l("label",{class:"block text-sm font-medium mb-1"},[r(" 이메일 "),l("span",{class:"text-red-500"},"*")],-1)),n(l("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>w.value=t),type:"email",class:"w-full border rounded px-3 py-2"},null,512),[[p,w.value]])]),l("div",null,[e[10]||(e[10]=l("label",{class:"block text-sm font-medium mb-1"},[r(" 닉네임 "),l("span",{class:"text-red-500"},"*")],-1)),n(l("input",{"onUpdate:modelValue":e[1]||(e[1]=t=>V.value=t),type:"text",maxlength:"16",pattern:"[A-Za-z0-9]+",placeholder:"2~16자 영문/숫자",class:"w-full border rounded px-3 py-2"},null,512),[[p,V.value]])]),l("div",null,[e[11]||(e[11]=l("label",{class:"block text-sm font-medium mb-1"},[r(" 이름 "),l("span",{class:"text-red-500"},"*")],-1)),n(l("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>c.value=t),type:"text",class:"w-full border rounded px-3 py-2"},null,512),[[p,c.value]])]),l("div",null,[e[13]||(e[13]=l("label",{class:"block text-sm font-medium mb-1"},"성별",-1)),n(l("select",{"onUpdate:modelValue":e[3]||(e[3]=t=>C.value=t),class:"w-full border rounded px-3 py-2"},[...e[12]||(e[12]=[l("option",{value:null},"선택 안함",-1),l("option",{value:"male"},"남성",-1),l("option",{value:"female"},"여성",-1)])],512),[[N,C.value]])]),l("div",null,[e[14]||(e[14]=l("label",{class:"block text-sm font-medium mb-1"},[r(" 국적 "),l("span",{class:"text-red-500"},"*")],-1)),O(H,{modelValue:U.value,"onUpdate:modelValue":e[4]||(e[4]=t=>U.value=t),"label-show":!1},null,8,["modelValue"])]),l("div",null,[e[15]||(e[15]=l("label",{class:"block text-sm font-medium mb-1"},[r(" 연락처 "),l("span",{class:"text-gray-400"},"(선택)")],-1)),l("div",Y,[n(l("input",{"onUpdate:modelValue":e[5]||(e[5]=t=>x.value=t),placeholder:"+82",class:"w-20 border rounded px-2 py-2"},null,512),[[p,x.value]]),n(l("input",{"onUpdate:modelValue":e[6]||(e[6]=t=>b.value=t),type:"tel",placeholder:"01012345678",class:"flex-1 border rounded px-3 py-2"},null,512),[[p,b.value]])]),e[16]||(e[16]=l("p",{class:"text-xs text-gray-500 mt-1"}," 이벤트 운영 및 긴급 연락 시 사용될 수 있습니다. ",-1))]),l("div",null,[e[17]||(e[17]=l("label",{class:"block text-sm font-medium mb-1"},[r(" 활동 지역 "),l("span",{class:"text-gray-400"},"(선택)")],-1)),n(l("input",{"onUpdate:modelValue":e[7]||(e[7]=t=>_.value=t),type:"text",placeholder:"예: 서울, 부산, 제주",class:"w-full border rounded px-3 py-2"},null,512),[[p,_.value]])]),l("div",null,[e[19]||(e[19]=l("label",{class:"block text-sm font-medium mb-1"},[r(" 스탠스 "),l("span",{class:"text-gray-400"},"(선택)")],-1)),n(l("select",{"onUpdate:modelValue":e[8]||(e[8]=t=>S.value=t),class:"w-full border rounded px-3 py-2"},[...e[18]||(e[18]=[l("option",{value:null},"선택 안함",-1),l("option",{value:"regular"},"레귤러 (왼발)",-1),l("option",{value:"goofy"},"구피 (오른발)",-1)])],512),[[N,S.value]])])]),l("div",$,[(d(!0),u(M,null,R(k.value,t=>(d(),u("label",{key:t.id,class:"flex gap-2"},[n(l("input",{type:"checkbox","onUpdate:modelValue":P=>f.value[t.id]=P},null,8,h),[[W,f.value[t.id]]]),l("span",null,[t.is_required?(d(),u("strong",ee,"[필수]")):(d(),u("strong",le,"[선택]")),r(" "+q(t.title)+" ",1),l("a",{href:t.content_url,target:"_blank",class:"ml-1 underline text-gray-500 text-xs"}," 보기 ",8,te)])]))),128))]),g.value?(d(),u("p",se,q(g.value),1)):z("",!0),l("button",{class:"w-full py-3 rounded bg-black text-white",disabled:!A.value||v.value,onClick:E},q(v.value?"처리 중...":"동의하고 계속하기"),9,ae)],64)):(d(),u("div",oe,[e[21]||(e[21]=l("h2",{class:"text-xl font-semibold"},"회원가입이 완료되었습니다",-1)),e[22]||(e[22]=l("p",{class:"text-sm text-gray-600"}," 이제 서비스를 바로 이용하실 수 있습니다. ",-1)),l("button",{class:"w-full py-3 rounded bg-black text-white",onClick:I}," 계속하기 ")]))]))}});export{de as default};
