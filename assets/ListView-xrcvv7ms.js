import{K as N,L as O,O as P,d as W,D as H,g as y,j,n as I,i as z,c as b,a as e,t as a,P as T,Q as G,F as v,r as E,s as u,R as Z,o as p,z as h,f as F}from"./index-ublk6XVv.js";function B(o){const r=new Map;for(const n of o)if(r.has(n.user_id)||r.set(n.user_id,{userId:n.user_id,provider:n.provider??"unknown",profile:{nickname:n.nickname??null,fullName:n.full_name??null},roles:[]}),n.role_id&&n.role_code){const _=r.get(n.user_id);_.roles.some(m=>m.code===n.role_code)||_.roles.push({id:n.role_id,code:n.role_code})}return Array.from(r.values())}async function U(){return N(async()=>{const{data:o,error:r}=await O.from("admin_role_member").select("user_id, provider, nickname, full_name, role_id, role_code");if(r)throw console.error("[fetchAdminRoleMemberRows]",r),r;return o??[]})}async function q(o,r){return N(async()=>{const{error:n}=await O.rpc("grant_role",{p_user_id:o,p_role_code:r});if(n)throw console.error("[grantRole]",n),n})}async function K(o,r){return N(async()=>{const{error:n}=await O.rpc("revoke_role",{p_user_id:o,p_role_code:r});if(n)throw console.error("[revokeRole]",n),n})}const Q=P("role",{state:()=>({members:[],loading:!1,error:null}),getters:{hasRole:o=>(r,n)=>{const _=o.members.find(d=>d.userId===r);return(_==null?void 0:_.roles.some(d=>d.code===n))??!1}},actions:{async fetchMembers(){this.loading=!0,this.error=null;try{const o=await U();this.members=B(o)}catch(o){this.error=(o==null?void 0:o.message)??"Failed to fetch members"}finally{this.loading=!1}},async toggleRole(o,r){const n=this.members.find(d=>d.userId===o);if(!n)return;const _=n.roles.some(d=>d.code===r);_?n.roles=n.roles.filter(d=>d.code!==r):n.roles.push({id:"temp",code:r});try{_?await K(o,r):await q(o,r)}catch{}finally{await this.fetchMembers()}}}}),i={ADMIN:"admin",CREW_LEADER:"crew.leader",EVENT_ORGANIZER:"event.organizer",SHOP_OWNER:"shop.owner"},x={ALL:"all",EVENT:"event",SHOP:"shop"},J=[x.ALL,x.EVENT,x.SHOP],X={class:"p-6 bg-neutral-50 dark:bg-neutral-900 min-h-[calc(100vh-54px)]"},Y={class:"text-lg font-semibold text-neutral-800 dark:text-neutral-100 mb-4"},ee={class:"text-sm text-neutral-600 dark:text-neutral-400 mb-4"},te={class:"mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4"},se=["value"],ne={class:"hidden md:flex flex-wrap gap-2"},re=["onClick"],le=["placeholder"],oe={class:"hidden md:block overflow-x-auto bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-sm"},ae={class:"w-full border-collapse"},ie={class:"bg-neutral-100 dark:bg-neutral-700"},de={class:"px-4 py-3 text-xs"},ue={class:"px-4 py-3 text-xs w-[180px]"},ce={class:"px-4 py-3 text-xs w-[180px]"},he={class:"px-4 py-3 text-xs w-[180px]"},_e={class:"px-4 py-3 text-xs w-[180px]"},be={class:"px-4 py-3 text-center"},pe={class:"px-4 py-3"},fe={class:"font-medium"},ge={class:"text-xs text-neutral-500"},xe={class:"px-4 py-3 text-center"},me={key:0},we={key:1,class:"text-neutral-400"},ke={class:"px-4 py-3 text-center"},ve=["onClick"],Ee={class:"px-4 py-3 text-center"},Re=["onClick"],ye={class:"px-4 py-3 text-center"},Ie=["onClick"],Ne={class:"md:hidden space-y-4"},Oe={class:"flex justify-between items-start"},Le={class:"font-medium"},Ce={class:"text-xs text-neutral-500"},Ae={key:0,class:"text-xs px-2 py-1 rounded-full bg-neutral-200 dark:bg-neutral-700"},$e={class:"mt-4 space-y-3"},Me={class:"flex justify-between items-center"},Se=["onClick"],De={class:"flex justify-between items-center"},Ve=["onClick"],Te={class:"flex justify-between items-center"},Pe=["onClick"],We={class:"mt-6 flex justify-center items-center gap-3"},He=["disabled"],je={class:"hidden md:inline text-sm"},ze=["disabled"],R=50,Ze=W({__name:"ListView",setup(o){const r=Q(),{t:n}=H(),_=J,d=y(x.ALL),m=s=>n(`admin.role.filter.${s}`),w=y(""),g=y(1);j(()=>{r.fetchMembers()});const c=(s,l)=>r.hasRole(s,l),L=I(()=>{let s=r.members;d.value===x.EVENT?s=s.filter(t=>t.roles.some(f=>f.code===i.EVENT_ORGANIZER)):d.value===x.SHOP&&(s=s.filter(t=>t.roles.some(f=>f.code===i.SHOP_OWNER)));const l=w.value.trim().toLowerCase();return l&&(s=s.filter(t=>{var D,V;const f=((D=t.profile.nickname)==null?void 0:D.toLowerCase())??"",k=((V=t.profile.fullName)==null?void 0:V.toLowerCase())??"";return f.includes(l)||k.includes(l)})),s}),C=I(()=>Math.max(1,Math.ceil(L.value.length/R))),A=I(()=>{const s=(g.value-1)*R;return L.value.slice(s,s+R)});z([d,w],()=>{g.value=1});function $(s){r.toggleRole(s,i.CREW_LEADER)}function M(s){r.toggleRole(s,i.EVENT_ORGANIZER)}function S(s){r.toggleRole(s,i.SHOP_OWNER)}return(s,l)=>(p(),b("main",X,[e("h3",Y,a(s.$t("admin.role.title")),1),e("p",ee,a(s.$t("admin.role.description")),1),e("div",te,[T(e("select",{"onUpdate:modelValue":l[0]||(l[0]=t=>d.value=t),class:"md:hidden w-full px-3 py-2 text-sm rounded-md border border-neutral-300 bg-white dark:bg-neutral-800 dark:border-neutral-600"},[(p(!0),b(v,null,E(u(_),t=>(p(),b("option",{key:t,value:t},a(m(t)),9,se))),128))],512),[[G,d.value]]),e("ul",ne,[(p(!0),b(v,null,E(u(_),t=>(p(),b("li",{key:t},[e("button",{onClick:f=>d.value=t,class:h(["px-3 py-1.5 text-sm rounded-full border transition",d.value===t?"bg-neutral-900 text-white border-neutral-900 dark:bg-white dark:text-neutral-900 dark:border-white":"bg-white text-neutral-700 border-neutral-300 hover:bg-neutral-100 dark:bg-neutral-800 dark:text-neutral-200 dark:border-neutral-600 dark:hover:bg-neutral-700"])},a(m(t)),11,re)]))),128))]),T(e("input",{"onUpdate:modelValue":l[1]||(l[1]=t=>w.value=t),type:"text",placeholder:s.$t("common.search.placeholder"),class:"w-full md:w-64 px-3 py-2 text-sm rounded-md border border-neutral-300 bg-white text-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-400 dark:bg-neutral-800 dark:text-neutral-100 dark:border-neutral-600"},null,8,le),[[Z,w.value]])]),e("div",oe,[e("table",ae,[e("thead",ie,[e("tr",null,[l[4]||(l[4]=e("th",{class:"px-4 py-3 text-xs w-16 text-center"},"#",-1)),e("th",de,a(s.$t("admin.role.table.user")),1),e("th",ue,a(s.$t("admin.role.table.admin")),1),e("th",ce,a(s.$t("admin.role.table.crewLeader")),1),e("th",he,a(s.$t("admin.role.table.eventOrganizer")),1),e("th",_e,a(s.$t("admin.role.table.shopOwner")),1)])]),e("tbody",null,[(p(!0),b(v,null,E(A.value,(t,f)=>(p(),b("tr",{key:t.userId,class:"border-t border-neutral-200 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition"},[e("td",be,a((g.value-1)*R+f+1),1),e("td",pe,[e("div",fe,a(t.profile.nickname||"—"),1),e("div",ge,a(t.profile.fullName),1)]),e("td",xe,[c(t.userId,u(i).ADMIN)?(p(),b("span",me,a(s.$t("admin.role.table.active")),1)):(p(),b("span",we,a(s.$t("admin.role.table.inactive")),1))]),e("td",ke,[e("button",{onClick:k=>$(t.userId),class:h([c(t.userId,u(i).CREW_LEADER)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-6 w-11 items-center rounded-full transition"])},[e("span",{class:h([c(t.userId,u(i).CREW_LEADER)?"translate-x-6 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-4 w-4 transform rounded-full transition"])},null,2)],10,ve)]),e("td",Ee,[e("button",{onClick:k=>M(t.userId),class:h([c(t.userId,u(i).EVENT_ORGANIZER)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-6 w-11 items-center rounded-full transition"])},[e("span",{class:h([c(t.userId,u(i).EVENT_ORGANIZER)?"translate-x-6 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-4 w-4 transform rounded-full transition"])},null,2)],10,Re)]),e("td",ye,[e("button",{onClick:k=>S(t.userId),class:h([c(t.userId,u(i).SHOP_OWNER)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-6 w-11 items-center rounded-full transition"])},[e("span",{class:h([c(t.userId,u(i).SHOP_OWNER)?"translate-x-6 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-4 w-4 transform rounded-full transition"])},null,2)],10,Ie)])]))),128))])])]),e("div",Ne,[(p(!0),b(v,null,E(A.value,t=>(p(),b("div",{key:t.userId,class:"rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 p-4"},[e("div",Oe,[e("div",null,[e("div",Le,a(t.profile.nickname||"—"),1),e("div",Ce,a(t.profile.fullName),1)]),c(t.userId,u(i).ADMIN)?(p(),b("span",Ae," ADMIN ")):F("",!0)]),e("div",$e,[e("div",Me,[l[5]||(l[5]=e("span",{class:"text-sm"},"Crew",-1)),e("button",{onClick:f=>$(t.userId),class:h([c(t.userId,u(i).CREW_LEADER)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-8 w-14 items-center rounded-full transition"])},[e("span",{class:h([c(t.userId,u(i).CREW_LEADER)?"translate-x-7 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-5 w-5 transform rounded-full transition"])},null,2)],10,Se)]),e("div",De,[l[6]||(l[6]=e("span",{class:"text-sm"},"Event",-1)),e("button",{onClick:f=>M(t.userId),class:h([c(t.userId,u(i).EVENT_ORGANIZER)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-8 w-14 items-center rounded-full transition"])},[e("span",{class:h([c(t.userId,u(i).EVENT_ORGANIZER)?"translate-x-7 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-5 w-5 transform rounded-full transition"])},null,2)],10,Ve)]),e("div",Te,[l[7]||(l[7]=e("span",{class:"text-sm"},"Shop",-1)),e("button",{onClick:f=>S(t.userId),class:h([c(t.userId,u(i).SHOP_OWNER)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-8 w-14 items-center rounded-full transition"])},[e("span",{class:h([c(t.userId,u(i).SHOP_OWNER)?"translate-x-7 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-5 w-5 transform rounded-full transition"])},null,2)],10,Pe)])])]))),128))]),e("div",We,[e("button",{onClick:l[2]||(l[2]=t=>g.value--),disabled:g.value===1,class:"px-3 py-1.5 text-sm rounded-md border disabled:opacity-40"},a(s.$t("common.pagination.prev")),9,He),e("span",je,a(g.value)+" / "+a(C.value),1),e("button",{onClick:l[3]||(l[3]=t=>g.value++),disabled:g.value===C.value,class:"px-3 py-1.5 text-sm rounded-md border disabled:opacity-40"},a(s.$t("common.pagination.next")),9,ze)])]))}});export{Ze as default};
