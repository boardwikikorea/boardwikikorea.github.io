import{w as N,s as O,O as P,d as W,u as H,r as k,x as $,g as E,f as z,c as _,b as t,t as i,e as n,k as S,S as F,F as R,h as y,v as G,o as h,n as f}from"./index-1UsboSlJ.js";function Z(o){const s=new Map;for(const e of o)if(s.has(e.user_id)||s.set(e.user_id,{userId:e.user_id,provider:e.provider??"unknown",profile:{nickname:e.nickname??null,fullName:e.full_name??null},roles:[]}),e.role_id&&e.role_code){const c=s.get(e.user_id);c.roles.some(x=>x.code===e.role_code)||c.roles.push({id:e.role_id,code:e.role_code})}return Array.from(s.values())}async function B(){return N(async()=>{const{data:o,error:s}=await O.from("admin_role_member").select("user_id, provider, nickname, full_name, role_id, role_code");if(s)throw console.error("[fetchAdminRoleMemberRows]",s),s;return o??[]})}async function j(o,s){return N(async()=>{const{error:e}=await O.rpc("grant_role",{p_user_id:o,p_role_code:s});if(e)throw console.error("[grantRole]",e),e})}async function U(o,s){return N(async()=>{const{error:e}=await O.rpc("revoke_role",{p_user_id:o,p_role_code:s});if(e)throw console.error("[revokeRole]",e),e})}const q=P("role",{state:()=>({members:[],loading:!1,error:null}),getters:{hasRole:o=>(s,e)=>{const c=o.members.find(a=>a.userId===s);return(c==null?void 0:c.roles.some(a=>a.code===e))??!1}},actions:{async fetchMembers(){this.loading=!0,this.error=null;try{const o=await B();this.members=Z(o)}catch(o){this.error=(o==null?void 0:o.message)??"Failed to fetch members"}finally{this.loading=!1}},async toggleRole(o,s){const e=this.members.find(a=>a.userId===o);if(!e)return;const c=e.roles.some(a=>a.code===s);c?e.roles=e.roles.filter(a=>a.code!==s):e.roles.push({id:"temp",code:s});try{c?await U(o,s):await j(o,s)}catch{}finally{await this.fetchMembers()}}}}),u={ADMIN:"admin",CREW_LEADER:"crew.leader",EVENT_ORGANIZER:"event.organizer",SHOP_OWNER:"shop.owner"},g={ALL:"all",EVENT:"event",SHOP:"shop"},J=[g.ALL,g.EVENT,g.SHOP],K={class:"bg-neutral-50 dark:bg-neutral-900 min-h-[calc(100vh-54px)]"},Q={class:"text-lg font-semibold text-neutral-800 dark:text-neutral-100 mb-4"},X={class:"text-sm text-neutral-600 dark:text-neutral-400 mb-4"},Y={class:"mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4"},ee=["value"],te={class:"hidden md:flex flex-wrap gap-2"},re=["onClick"],se=["placeholder"],ne={class:"hidden md:block overflow-x-auto bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-sm"},oe={class:"w-full border-collapse"},le={class:"bg-neutral-100 dark:bg-neutral-700"},ae={class:"px-4 py-3 text-xs"},ie={class:"px-4 py-3 text-xs w-[180px]"},de={class:"px-4 py-3 text-xs w-[180px]"},ce={class:"px-4 py-3 text-xs w-[180px]"},ue={class:"px-4 py-3 text-xs w-[180px]"},_e={class:"px-4 py-3 text-center"},he={class:"px-4 py-3"},pe={class:"font-medium"},be={class:"text-xs text-neutral-500"},me={class:"px-4 py-3 text-center"},fe={key:0},xe={key:1,class:"text-neutral-400"},ge={class:"px-4 py-3 text-center"},we=["onClick"],ve={class:"px-4 py-3 text-center"},ke=["onClick"],Ee={class:"px-4 py-3 text-center"},Re=["onClick"],ye={class:"mt-6 flex justify-center items-center gap-3"},Ne=["disabled"],Oe={class:"hidden md:inline text-sm"},Ie=["disabled"],v=50,Ae=W({__name:"ListView",setup(o){const s=q(),{t:e}=H(),c=J,a=k(g.ALL),x=k(""),p=k(1);$(()=>{s.fetchMembers()});const m=(l,d)=>s.hasRole(l,d),I=E(()=>{let l=s.members;a.value===g.EVENT?l=l.filter(r=>r.roles.some(b=>b.code===u.EVENT_ORGANIZER)):a.value===g.SHOP&&(l=l.filter(r=>r.roles.some(b=>b.code===u.SHOP_OWNER)));const d=x.value.trim().toLowerCase();return d&&(l=l.filter(r=>{var A,M;const b=((A=r.profile.nickname)==null?void 0:A.toLowerCase())??"",w=((M=r.profile.fullName)==null?void 0:M.toLowerCase())??"";return b.includes(d)||w.includes(d)})),l}),L=E(()=>Math.max(1,Math.ceil(I.value.length/v))),C=E(()=>{const l=(p.value-1)*v;return I.value.slice(l,l+v)});z([a,x],()=>{p.value=1});function T(l){s.toggleRole(l,u.CREW_LEADER)}function V(l){s.toggleRole(l,u.EVENT_ORGANIZER)}function D(l){s.toggleRole(l,u.SHOP_OWNER)}return(l,d)=>(h(),_("main",K,[t("h3",Q,i(n(e)("admin.role.title")),1),t("p",X,i(n(e)("admin.role.description")),1),t("div",Y,[S(t("select",{"onUpdate:modelValue":d[0]||(d[0]=r=>a.value=r),class:"md:hidden w-full px-3 py-2 text-sm rounded-md border border-neutral-300 bg-white dark:bg-neutral-800 dark:border-neutral-600"},[(h(!0),_(R,null,y(n(c),r=>(h(),_("option",{key:r,value:r},i(n(e)(`admin.role.filter.${r}`)),9,ee))),128))],512),[[F,a.value]]),t("ul",te,[(h(!0),_(R,null,y(n(c),r=>(h(),_("li",{key:r},[t("button",{onClick:b=>a.value=r,class:f(["px-3 py-1.5 text-sm rounded-full border transition",a.value===r?"bg-neutral-900 text-white border-neutral-900 dark:bg-white dark:text-neutral-900 dark:border-white":"bg-white text-neutral-700 border-neutral-300 hover:bg-neutral-100 dark:bg-neutral-800 dark:text-neutral-200 dark:border-neutral-600 dark:hover:bg-neutral-700"])},i(n(e)(`admin.role.filter.${r}`)),11,re)]))),128))]),S(t("input",{"onUpdate:modelValue":d[1]||(d[1]=r=>x.value=r),type:"text",placeholder:n(e)("common.search.placeholder"),class:"w-full md:w-64 px-3 py-2 text-sm rounded-md border border-neutral-300 bg-white text-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-400 dark:bg-neutral-800 dark:text-neutral-100 dark:border-neutral-600"},null,8,se),[[G,x.value]])]),t("div",ne,[t("table",oe,[t("thead",le,[t("tr",null,[d[4]||(d[4]=t("th",{class:"px-4 py-3 text-xs w-16 text-center"},"#",-1)),t("th",ae,i(n(e)("admin.role.table.user")),1),t("th",ie,i(n(e)("admin.role.table.admin")),1),t("th",de,i(n(e)("admin.role.table.crewLeader")),1),t("th",ce,i(n(e)("admin.role.table.eventOrganizer")),1),t("th",ue,i(n(e)("admin.role.table.shopOwner")),1)])]),t("tbody",null,[(h(!0),_(R,null,y(C.value,(r,b)=>(h(),_("tr",{key:r.userId,class:"border-t border-neutral-200 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition"},[t("td",_e,i((p.value-1)*v+b+1),1),t("td",he,[t("div",pe,i(r.profile.nickname||"â€”"),1),t("div",be,i(r.profile.fullName),1)]),t("td",me,[m(r.userId,n(u).ADMIN)?(h(),_("span",fe,i(n(e)("admin.role.table.active")),1)):(h(),_("span",xe,i(n(e)("admin.role.table.inactive")),1))]),t("td",ge,[t("button",{onClick:w=>T(r.userId),class:f([m(r.userId,n(u).CREW_LEADER)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-6 w-11 items-center rounded-full transition"])},[t("span",{class:f([m(r.userId,n(u).CREW_LEADER)?"translate-x-6 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-4 w-4 transform rounded-full transition"])},null,2)],10,we)]),t("td",ve,[t("button",{onClick:w=>V(r.userId),class:f([m(r.userId,n(u).EVENT_ORGANIZER)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-6 w-11 items-center rounded-full transition"])},[t("span",{class:f([m(r.userId,n(u).EVENT_ORGANIZER)?"translate-x-6 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-4 w-4 transform rounded-full transition"])},null,2)],10,ke)]),t("td",Ee,[t("button",{onClick:w=>D(r.userId),class:f([m(r.userId,n(u).SHOP_OWNER)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-6 w-11 items-center rounded-full transition"])},[t("span",{class:f([m(r.userId,n(u).SHOP_OWNER)?"translate-x-6 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-4 w-4 transform rounded-full transition"])},null,2)],10,Re)])]))),128))])])]),t("div",ye,[t("button",{onClick:d[2]||(d[2]=r=>p.value--),disabled:p.value===1,class:"px-3 py-1.5 text-sm rounded-md border disabled:opacity-40"},i(n(e)("common.pagination.prev")),9,Ne),t("span",Oe,i(p.value)+" / "+i(L.value),1),t("button",{onClick:d[3]||(d[3]=r=>p.value++),disabled:p.value===L.value,class:"px-3 py-1.5 text-sm rounded-md border disabled:opacity-40"},i(n(e)("common.pagination.next")),9,Ie)])]))}});export{Ae as default};
