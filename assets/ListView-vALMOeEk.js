import{w as v,s as y,b as P,d as z,e as T,r as k,f as A,g as w,h as H,c as b,i as e,t as a,j as B,F as M,k as N,v as D,l as F,o as x,n as f}from"./index-DNVwaNb1.js";function W(l){const n=new Map;for(const r of l)if(n.has(r.user_id)||n.set(r.user_id,{userId:r.user_id,provider:r.provider??"unknown",profile:{nickname:r.nickname??null,fullName:r.full_name??null},roles:[]}),r.role_id&&r.role_code){const u=n.get(r.user_id);u.roles.some(g=>g.code===r.role_code)||u.roles.push({id:r.role_id,code:r.role_code})}return Array.from(n.values())}async function j(){return v(async()=>{const{data:l,error:n}=await y.from("admin_role_member").select("user_id, provider, nickname, full_name, role_id, role_code");if(n)throw console.error("[fetchAdminRoleMemberRows]",n),n;return l??[]})}async function q(l,n){return v(async()=>{const{error:r}=await y.rpc("grant_role",{p_user_id:l,p_role_code:n});if(r)throw console.error("[grantRole]",r),r})}async function U(l,n){return v(async()=>{const{error:r}=await y.rpc("revoke_role",{p_user_id:l,p_role_code:n});if(r)throw console.error("[revokeRole]",r),r})}const G=P("role",{state:()=>({members:[],loading:!1,error:null}),getters:{hasRole:l=>(n,r)=>{const u=l.members.find(o=>o.userId===n);return(u==null?void 0:u.roles.some(o=>o.code===r))??!1}},actions:{async fetchMembers(){this.loading=!0,this.error=null;try{const l=await j();this.members=W(l)}catch(l){this.error=(l==null?void 0:l.message)??"Failed to fetch members"}finally{this.loading=!1}},async toggleRole(l,n){const r=this.members.find(o=>o.userId===l);if(!r)return;const u=r.roles.some(o=>o.code===n);u?r.roles=r.roles.filter(o=>o.code!==n):r.roles.push({id:"temp",code:n});try{u?await U(l,n):await q(l,n)}catch{}finally{await this.fetchMembers()}}}}),J={class:"p-6 bg-neutral-50 dark:bg-neutral-900 min-h-[calc(100vh-54px)]"},K={class:"text-lg font-semibold text-neutral-800 dark:text-neutral-100 mb-4"},Q={class:"text-sm text-neutral-600 dark:text-neutral-400 mb-4"},X={class:"mb-6 flex flex-wrap items-center justify-between gap-4"},Y={class:"flex flex-wrap gap-2"},Z=["onClick"],ee=["placeholder"],te={class:"overflow-x-auto bg-white dark:bg-neutral-800 border border-neutral-200 dark:border-neutral-700 rounded-lg shadow-sm"},re={class:"w-full border-collapse"},se={class:"bg-neutral-100 dark:bg-neutral-700"},ne={class:"px-4 py-3 text-xs font-semibold uppercase tracking-wide text-neutral-500 dark:text-neutral-300"},le={class:"px-4 py-3 text-xs font-semibold text-neutral-500 w-[180px]"},ae={class:"px-4 py-3 text-xs font-semibold text-neutral-500 w-[180px]"},oe={class:"px-4 py-3 text-xs font-semibold text-neutral-500 w-[180px]"},ie={class:"px-4 py-3 text-xs font-semibold text-neutral-500 w-[180px]"},de={class:"px-4 py-3 text-sm text-neutral-500 dark:text-neutral-400 text-center"},ue={class:"px-4 py-3"},ce={class:"flex flex-col"},pe={class:"text-sm text-neutral-900 dark:text-neutral-100"},he={class:"text-xs text-neutral-500 dark:text-neutral-400"},be={class:"px-4 py-3 text-center w-[180px]"},xe={key:0,class:"inline-flex items-center px-2 py-1 text-xs rounded-full bg-neutral-200 text-neutral-700 dark:bg-neutral-700 dark:text-neutral-200"},fe={key:1,class:"text-xs text-neutral-400"},ge={class:"px-4 py-3 w-[180px] text-center"},me=["onClick"],_e={class:"px-4 py-3 w-[180px] text-center"},ke=["onClick"],we={class:"px-4 py-3 w-[180px] text-center"},ve=["onClick"],ye={key:0},Re={colspan:"4",class:"px-4 py-10 text-center text-sm text-neutral-500 dark:text-neutral-400"},$e={class:"mt-6 flex justify-center items-center gap-3"},Ce=["disabled"],Ee={class:"text-sm text-neutral-600 dark:text-neutral-400"},Ie=["disabled"],_=50,Ne=z({__name:"ListView",setup(l){const n=G(),{t:r}=T(),u=["all","event","shop"],o=k("all"),g=k(""),c=k(1),O=t=>r(`admin.role.filter.${t}`),d={ADMIN:"admin",CREW:"crew.leader",EVENT:"event.organizer",SHOP:"shop.owner"};A(()=>{n.fetchMembers()});const h=(t,i)=>n.hasRole(t,i),R=w(()=>{let t=n.members;o.value==="event"?t=t.filter(s=>s.roles.some(p=>p.code===d.EVENT)):o.value==="shop"&&(t=t.filter(s=>s.roles.some(p=>p.code===d.SHOP)));const i=g.value.trim().toLowerCase();return i&&(t=t.filter(s=>{var E,I;const p=((E=s.profile.nickname)==null?void 0:E.toLowerCase())??"",m=((I=s.profile.fullName)==null?void 0:I.toLowerCase())??"";return p.includes(i)||m.includes(i)})),t}),$=w(()=>Math.max(1,Math.ceil(R.value.length/_))),C=w(()=>{const t=(c.value-1)*_;return R.value.slice(t,t+_)});H([o,g],()=>{c.value=1});function S(t){n.toggleRole(t,d.CREW)}function L(t){n.toggleRole(t,d.EVENT)}function V(t){n.toggleRole(t,d.SHOP)}return(t,i)=>(x(),b("main",J,[e("h3",K,a(t.$t("admin.role.title")),1),e("p",Q,a(t.$t("admin.role.description")),1),e("div",X,[e("ul",Y,[(x(),b(M,null,N(u,s=>e("li",{key:s},[e("button",{onClick:p=>o.value=s,class:f(["px-3 py-1.5 text-sm rounded-full border transition",o.value===s?"bg-neutral-900 text-white border-neutral-900 dark:bg-white dark:text-neutral-900 dark:border-white":"bg-white text-neutral-700 border-neutral-300 hover:bg-neutral-100 dark:bg-neutral-800 dark:text-neutral-200 dark:border-neutral-600 dark:hover:bg-neutral-700"])},a(O(s)),11,Z)])),64))]),B(e("input",{"onUpdate:modelValue":i[0]||(i[0]=s=>g.value=s),type:"text",placeholder:t.$t("common.search.placeholder"),class:"w-64 px-3 py-2 text-sm rounded-md border border-neutral-300 bg-white text-neutral-800 focus:outline-none focus:ring-2 focus:ring-neutral-400 dark:bg-neutral-800 dark:text-neutral-100 dark:border-neutral-600"},null,8,ee),[[D,g.value]])]),e("div",te,[e("table",re,[e("thead",se,[e("tr",null,[i[3]||(i[3]=e("th",{class:"px-4 py-3 text-xs font-semibold uppercase tracking-wide text-neutral-500 dark:text-neutral-300 w-16 text-center"}," # ",-1)),e("th",ne,a(t.$t("admin.role.table.user")),1),e("th",le,a(t.$t("admin.role.table.admin")),1),e("th",ae,a(t.$t("admin.role.table.crewLeader")),1),e("th",oe,a(t.$t("admin.role.table.eventOrganizer")),1),e("th",ie,a(t.$t("admin.role.table.shopOwner")),1)])]),e("tbody",null,[(x(!0),b(M,null,N(C.value,(s,p)=>(x(),b("tr",{key:s.userId,class:"border-t border-neutral-200 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-700 transition"},[e("td",de,a((c.value-1)*_+p+1),1),e("td",ue,[e("div",ce,[e("span",pe,a(s.profile.nickname||"â€”"),1),e("span",he,a(s.profile.fullName),1)])]),e("td",be,[h(s.userId,d.ADMIN)?(x(),b("span",xe,a(t.$t("admin.role.table.active")),1)):(x(),b("span",fe,a(t.$t("admin.role.table.inactive")),1))]),e("td",ge,[e("button",{onClick:m=>S(s.userId),class:f([h(s.userId,d.CREW)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-6 w-11 items-center rounded-full transition"])},[e("span",{class:f([h(s.userId,d.CREW)?"translate-x-6 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-4 w-4 transform rounded-full transition"])},null,2)],10,me)]),e("td",_e,[e("button",{onClick:m=>L(s.userId),class:f([h(s.userId,d.EVENT)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-6 w-11 items-center rounded-full transition"])},[e("span",{class:f([h(s.userId,d.EVENT)?"translate-x-6 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-4 w-4 transform rounded-full transition"])},null,2)],10,ke)]),e("td",we,[e("button",{onClick:m=>V(s.userId),class:f([h(s.userId,d.SHOP)?"bg-neutral-900 dark:bg-white":"bg-neutral-300 dark:bg-neutral-600","relative inline-flex h-6 w-11 items-center rounded-full transition"])},[e("span",{class:f([h(s.userId,d.SHOP)?"translate-x-6 bg-white dark:bg-neutral-900":"translate-x-1 bg-white","inline-block h-4 w-4 transform rounded-full transition"])},null,2)],10,ve)])]))),128)),C.value.length===0?(x(),b("tr",ye,[e("td",Re,a(t.$t("admin.role.empty")),1)])):F("",!0)])])]),e("div",$e,[e("button",{onClick:i[1]||(i[1]=s=>c.value--),disabled:c.value===1,class:"px-3 py-1.5 text-sm rounded-md border disabled:opacity-40 disabled:cursor-not-allowed bg-white hover:bg-neutral-100 dark:bg-neutral-800 dark:hover:bg-neutral-700"},[e("button",null,a(t.$t("common.pagination.prev")),1)],8,Ce),e("span",Ee,a(c.value)+" / "+a($.value),1),e("button",{onClick:i[2]||(i[2]=s=>c.value++),disabled:c.value===$.value,class:"px-3 py-1.5 text-sm rounded-md border disabled:opacity-40 disabled:cursor-not-allowed bg-white hover:bg-neutral-100 dark:bg-neutral-800 dark:hover:bg-neutral-700"},[e("button",null,a(t.$t("common.pagination.next")),1)],8,Ie)])]))}});export{Ne as default};
