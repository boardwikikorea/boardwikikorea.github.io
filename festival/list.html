<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>롱보드 페스티벌</title>

    <!-- SEO 최적화 -->
    <meta name="description" content="보드위키에서 최신 스케이트, 롱보드 정보와 롱보드댄싱, 보드대회 소식을 확인하세요.">
    <meta name="keywords" content="스케이트, 롱보드, 카버보드, 롱보드댄싱, 보드대회, longboarding, 롱보드 페스티벌, 롱보드 페스티벌, longboard festival">
    <meta name="naver-site-verification" content="e74dc3e49d0527046508b26ee9860c52a501b8f4">

    <!-- Open Graph (OG) -->
    <meta property="og:site_name" content="BoardWiki">
    <meta property="og:title" content="롱보드 페스티벌">
    <meta property="og:description" content="스케이트·롱보드 최신 정보를 확인하세요.">
    <meta property="og:url" content="https://boardwiki.kr">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://boardwiki.kr/images/og-image.jpg?ver=20250930">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="보드위키 - 스케이트·롱보드 커뮤니티">
    <meta name="twitter:description" content="보드위키에서 최신 스케이트, 롱보드 정보를 만나보세요.">
    <meta name="twitter:image" content="https://boardwiki.kr/images/twitter-image.jpg">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://boardwiki.kr/">

    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/common.css?ver250314">
    <link rel="stylesheet" href="../css/festival.css?ver=250317">

    <!-- JS -->
    <script src="../js/common.js" defer></script>


    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDDkghHYAD581-N3u8zUUsinS1F49P5xi0",
    authDomain: "boardwiki-e070e.firebaseapp.com",
    projectId: "boardwiki-e070e",
    storageBucket: "boardwiki-e070e.appspot.com",
    messagingSenderId: "301441212066",
    appId: "1:301441212066:web:1ffff5d8eccaaff11781fb",
    measurementId: "G-DZ52LV9MMG"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Fisher-Yates 셔플
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  async function fetchAllApplications() {
    const querySnapshot = await getDocs(collection(db, "festivalApplications"));
    const allData = [];

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      allData.push({ id: doc.id, ...data });
    });

    // 1. 최신순 정렬
    allData.sort((a, b) => {
      const timeA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
      const timeB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
      return timeB - timeA;
    });

    // 2. name+contact 기준으로 중복 제거(최신 유지)
    const uniqueData = [];
    const seenKeys = new Set();
    for (const entry of allData) {
      const name = (entry.name || "").toString().trim();
      const contact = (entry.contact || "").toString().trim();
      const key = `${name}_${contact}`;
      if (name && contact && !seenKeys.has(key)) {
        uniqueData.push(entry);
        seenKeys.add(key);
      }
    }

    // 3. 키 목록 생성 및 signature
    const keys = uniqueData.map(d => {
      const name = (d.name || "").toString().trim();
      const contact = (d.contact || "").toString().trim();
      return `${name}_${contact}`;
    });
    const keysSignature = keys.slice().sort().join("|");

    // 4. mapping 불러오기/생성 (localStorage)
    let saved = null;
    try { saved = JSON.parse(localStorage.getItem("randomOrderByKey")) || null; } catch(e) { saved = null; }

    let mapping = {};
    if (saved && saved.__signature === keysSignature) {
      mapping = saved.mapping || {};
    } else {
      const N = keys.length;
      const numbers = Array.from({ length: N }, (_, i) => i + 1);
      shuffle(numbers);
      mapping = {};
      keys.forEach((k, idx) => mapping[k] = numbers[idx]);
      const toSave = { __signature: keysSignature, mapping };
      localStorage.setItem("randomOrderByKey", JSON.stringify(toSave));
    }

    // 5. 카테고리별로 참가자(객체: {name, key, order}) 수집
    const categories = {
      "프리스타일 (Freestyle) 일반부 None Sponsor_(남, Male)": [],
      "프리스타일 (Freestyle) 일반부 None Sponsor_(여, Female)": [],
      "프리스타일 (Freestyle) 오픈부 Sponsor_(남, Male)": [],
      "프리스타일 (Freestyle) 오픈부 Sponsor_(여, Female)": [],
      "프리스타일 (Freestyle) 마스터부 (Master)": [],
      "히피점프 Hippy Jump": [],
      "레이스 Race": []
    };

    uniqueData.forEach((d) => {
      const name = (d.name || "").toString().trim();
      const contact = (d.contact || "").toString().trim();
      const key = `${name}_${contact}`;
      const order = mapping[key] || 999999; // 안전값

      const genderSuffix = d.gender === "male" ? "남, Male" : "여, Female";

      if (d.freestyle === "amateur")
        categories[`프리스타일 (Freestyle) 일반부 None Sponsor_(${genderSuffix})`]
          .push({ name, key, order, song: d.song || "" });

      if (d.freestyle === "open")
        categories[`프리스타일 (Freestyle) 오픈부 Sponsor_(${genderSuffix})`]
          .push({ name, key, order, song: d.song || "" });

      if (d.freestyle === "master")
        categories["프리스타일 (Freestyle) 마스터부 (Master)"]
          .push({ name, key, order, song: d.song || "" });



      if (d.hippyJump) categories["히피점프 Hippy Jump"].push({ name, key, order });
      if (d.race) categories["레이스 Race"].push({ name, key, order });

    });

    // 6. 카테고리별로 order 오름차순 정렬 후 렌더링
    const container = document.querySelector(".category-list");
    container.innerHTML = "";

    for (const [category, entries] of Object.entries(categories)) {
      // 정렬 (order 오름차순)
      entries.sort((a, b) => a.order - b.order);

      const section = document.createElement("section");
      section.innerHTML = `
        <h3 style="margin-top: 1.5rem;">${category} - ${entries.length}명</h3>
        <ul></ul>
      `;
      const ul = section.querySelector("ul");

      if (entries.length === 0) {
        ul.innerHTML = `<li style="padding:0.5rem">없음</li>`;
      } else {
        // 각 항목: 번호 + 이름 (원하면 더 많은 정보 추가 가능)
        entries.forEach(e => {
          console.log(e);
          const li = document.createElement("li");
          li.style.listStyle = "none";
          li.style.border = "1px solid #ddd";
          li.style.padding = "0.6rem";
          li.style.textAlign = "left";
          li.style.paddingLeft ="20px";
          li.innerHTML = `[${String(e.order).padStart(2, '0')}] ${e.name} ${e.song ? '- ('+e.song+')' : ''}`;
          ul.appendChild(li);
        });
      }

      container.appendChild(section);
    }
  }

  // 자동 로드
  window.onload = () => {
    fetchAllApplications();
  };
</script>



  <style>
    .category-list { margin-bottom: 3rem; }
    .category-list h3 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      border-bottom: 2px solid #ccc;
      padding-bottom: 0.5rem;
    }

    .category-list ul {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      border-top:1px solid #ddd;
    }

    .category-list li{
      border: 1px solid #ddd;
      border-top:0;
      padding: 0.75rem;
      text-align: left;
    }


    .category-list li:nth-child(even){
      background-color: #fafafa;
    }

    button#fetch-all-reservations {
      background-color: #333;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    button#fetch-all-reservations:hover {
      background-color: #555;
    }
  </style>
</head>

<body id="festival">
  <h1 class="sound_only">롱보드 페스티벌</h1>

    <div class="language-switcher">
        <button type="button" class="active" id="btn-kr">KR</button>
        <button type="button" id="btn-en">EN</button>
    </div>

    
  <div class="wrap main">


  
    <article class="content">

      <div class="form-header">
        <h2>참가자 목록 (Participant List)</h2>
        <a href="./index.html" class="close-btn">✖</a>
      </div>
      
      <div class="category-list" style="margin-top: 2rem;">

      </div>

    </article>
    <footer>서비스 제공 <a href="../index.html">@boardwiki</a></footer>
  </div>
</body>
</html>
