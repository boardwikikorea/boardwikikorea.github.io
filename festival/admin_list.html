<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>롱보드 페스티벌</title>

    <!-- SEO 최적화 -->
    <meta name="description" content="보드위키에서 최신 스케이트보드 및 롱보드 정보, 롱보드댄싱과 대회 소식을 만나보세요.">
    <meta name="naver-site-verification" content="e74dc3e49d0527046508b26ee9860c52a501b8f4">

    <!-- Open Graph (OG) -->
    <meta property="og:site_name" content="BoardWiki">
    <meta property="og:title" content="보드 커뮤니티">
    <meta property="og:description" content="최신 보드 소식을 확인하세요.">
    <meta property="og:url" content="https://boardwiki.kr">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://boardwiki.kr/images/og-image.jpg?ver=20250930">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="보드위키 - 보드 커뮤니티">
    <meta name="twitter:description" content="최신 보드 소식을 확인하세요.">
    <meta name="twitter:image" content="https://boardwiki.kr/images/twitter-image.jpg">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://boardwiki.kr/">

    <!-- Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

    <!-- CSS -->
    <link rel="stylesheet" href="../css/common.css?ver250314">
    <link rel="stylesheet" href="../css/festival.css?ver=250317">

    <!-- JS -->
    <script src="../js/common.js" defer></script>
</head>

<body id="festival">
    <h1 class="sound_only">롱보드 페스티벌</h1>

    <div class="wrap main">
        <article class="content">
            <!-- 전체 조회 버튼 추가 -->
            <button id="fetch-all-reservations">전체 조회</button>

            <div style="overflow-x: auto; margin-top: 1rem;">

            <table id="applicationsTable" style="max-width: 1200px; border-collapse: collapse;">
                <thead>
                    <tr>
                    <th style="padding:8px; border:1px solid #ddd;">이름</th>
                    <th style="padding:8px; border:1px solid #ddd;">고유 런 순서</th>
                    <th style="padding:8px; border:1px solid #ddd;">연락처</th>
                    <th style="padding:8px; border:1px solid #ddd;">성별</th>
                    <th style="padding:8px; border:1px solid #ddd;">스탠스</th>
                    <th style="padding:8px; border:1px solid #ddd;">소속</th>
                    <th style="padding:8px; border:1px solid #ddd;">프리스타일</th>
                    <th style="padding:8px; border:1px solid #ddd;">히피점프</th>
                    <th style="padding:8px; border:1px solid #ddd;">베스트페어</th>
                    <th style="padding:8px; border:1px solid #ddd;">레이스</th>
                    <th style="padding:8px; border:1px solid #ddd;">신청곡</th>
                    <th style="padding:8px; border:1px solid #ddd;">신청일</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            </div>
        </article>

        <footer style="margin-top:1rem;">
            서비스 제공 <a href="../index.html">@boardwiki</a>
        </footer>
    </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDDkghHYAD581-N3u8zUUsinS1F49P5xi0",
    authDomain: "boardwiki-e070e.firebaseapp.com",
    projectId: "boardwiki-e070e",
    storageBucket: "boardwiki-e070e.appspot.com",
    messagingSenderId: "301441212066",
    appId: "1:301441212066:web:1ffff5d8eccaaff11781fb",
    measurementId: "G-DZ52LV9MMG"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Fisher-Yates 셔플
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  async function fetchAllApplications() {
    const querySnapshot = await getDocs(collection(db, "festivalApplications"));
    const allData = [];

    querySnapshot.forEach((doc) => {
      const data = doc.data();
      allData.push({ id: doc.id, ...data });
    });

    // 1️⃣ createdAt 기준으로 최신순 정렬
    allData.sort((a, b) => {
      const timeA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
      const timeB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
      return timeB - timeA; // 최신순
    });

    // 2️⃣ 이름 + 연락처 기준으로 중복 제거 (가장 최신만 유지)
    const uniqueData = [];
    const seenKeys = new Set();

    for (const entry of allData) {
      const name = (entry.name || "").toString().trim();
      const contact = (entry.contact || "").toString().trim();
      const key = `${name}_${contact}`;

      if (name && contact && !seenKeys.has(key)) {
        uniqueData.push(entry);
        seenKeys.add(key);
      }
    }

    // 3️⃣ 고유 번호(1..N) 할당 — localStorage에 저장해서 새로고침해도 유지
    const keys = uniqueData.map(d => {
      const name = (d.name || "").toString().trim();
      const contact = (d.contact || "").toString().trim();
      return `${name}_${contact}`;
    });

    // 불변 키 문자열(정렬된)로 비교하기 위해 정렬된 문자열 사용
    const keysSignature = keys.slice().sort().join("|");

    // 로컬스토리지에서 저장된 매핑 불러오기
    let saved = null;
    try {
      saved = JSON.parse(localStorage.getItem("randomOrderByKey")) || null;
    } catch (e) {
      saved = null;
    }

    // 저장된 매핑이 현재 키 집합과 동일한지 확인
    let needRegenerate = true;
    if (saved && saved.__signature === keysSignature) {
      needRegenerate = false;
    }

    let mapping = {};
    if (!needRegenerate) {
      mapping = saved.mapping || {};
    } else {
      // 새로 생성: 1..N을 섞어서 키에 맵핑
      const N = keys.length;
      const numbers = Array.from({ length: N }, (_, i) => i + 1);
      shuffle(numbers);
      mapping = {};
      keys.forEach((k, idx) => {
        mapping[k] = numbers[idx];
      });
      // 저장 (signature 포함)
      const toSave = {
        __signature: keysSignature,
        mapping
      };
      localStorage.setItem("randomOrderByKey", JSON.stringify(toSave));
    }

    // 4️⃣ 테이블 렌더링
    const tableBody = document.querySelector("#applicationsTable tbody");
    tableBody.innerHTML = "";

    uniqueData.forEach((data) => {
      const freestyleLabel = {
        amateur: "일반부",
        open: "오픈부",
        master: "마스터부",
        none: "없음"
      }[data.freestyle] || "없음";

      const name = (data.name || "").toString().trim();
      const contact = (data.contact || "").toString().trim();
      const key = `${name}_${contact}`;
      const assignedNumber = mapping[key] || "-";

      const createdAt = data.createdAt?.toDate
        ? data.createdAt.toDate().toLocaleString("ko-KR")
        : "-";

      const row = document.createElement("tr");
      row.style.borderBottom = "1px solid #eee";
      row.innerHTML = `
        <td style="padding:8px; border:1px solid #ddd;" id="${data.id}">${name || "-"}</td>
        <td style="padding:8px; border:1px solid #ddd;">${assignedNumber}</td>
        <td style="padding:8px; border:1px solid #ddd;">${contact || "-"}</td>
        <td style="padding:8px; border:1px solid #ddd;">${data.gender === "male" ? "남" : "여"}</td>
        <td style="padding:8px; border:1px solid #ddd;">${data.stance || "-"}</td>
        <td style="padding:8px; border:1px solid #ddd;">${data.team || "-"}</td>
        <td style="padding:8px; border:1px solid #ddd;">${freestyleLabel}</td>
        <td style="padding:8px; border:1px solid #ddd;">${data.hippyJump ? "✅" : "❌"}</td>
        <td style="padding:8px; border:1px solid #ddd;">${data.bestPair ? "✅" : "❌"}</td>
        <td style="padding:8px; border:1px solid #ddd;">${data.race ? "✅" : "❌"}</td>
        <td style="padding:8px; border:1px solid #ddd;">${data.song || "-"}</td>
        <td style="padding:8px; border:1px solid #ddd;">${createdAt}</td>
      `;
      tableBody.appendChild(row);
    });
  }

  window.onload = () => {
    const btn = document.getElementById("fetch-all-reservations");

    // 바로 로드
    fetchAllApplications();

    btn.addEventListener("click", () => {
      const password = prompt("관리자 암호를 입력하세요:");
      if (password === "202511") {
        fetchAllApplications();
      } else {
        alert("잘못된 암호입니다.");
      }
    });
  };
</script>

</body>

</html>
